<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SolarGenWizard - Прогнозування генерації сонячної системи</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="miniapps-common.css">
    <link rel="stylesheet" href="solarwizard-styles.css">
</head>
<body>
    <a href="../index.html" class="back-button">← Повернутися до меню</a>
    <div class="header">
        <i class="bi bi-sun header-icon"></i>
        <h1>SolarGenWizard</h1>
        <p>Прогнозування генерації сонячної електростанції та економічної вигоди</p>
    </div>

    <div class="main-content">
        <form id="solarWizardForm" autocomplete="off">
            <label class="form-label"><i class="info-icon bi bi-geo-alt"></i>Регіон:</label>
            <select class="form-input" id="regionSelect">
                <!-- Буде заповнено динамічно -->
            </select>
            
            <label class="form-label"><i class="info-icon bi bi-lightning-charge"></i>Потужність панелей(кВт):</label>
            <div class="power-input-container">
                <input type="number" class="form-input" id="powerInput" min="1" step="0.1" value="10" required>
                <div class="auto-power-checkbox">
                    <input type="checkbox" id="autoPowerCheckbox">
                    <label for="autoPowerCheckbox">Автопідбір</label>
                </div>
            </div>
            <div id="powerAutoInfo" class="auto-power-info" style="display: none;"></div>
            
            <label class="form-label"><i class="info-icon bi bi-house-door"></i>Власне споживання(кВт·год/міс, необов'язково):</label>
            <input type="number" class="form-input" id="consumptionInput" min="0" step="1" value="300">
            
            <div class="advanced-params-header">
                <a href="#" id="toggleAdvancedParams"><i class="bi bi-gear"></i> Розширені параметри</a>
            </div>
            
            <div id="advancedParams" style="display: none;">
                <label class="form-label"><i class="info-icon bi bi-currency-euro"></i>Зелений тариф (€/кВт·год):</label>
                <input type="number" class="form-input" id="greenTariffInput" min="0.01" step="0.01" value="0.16">
                
                <label class="form-label"><i class="info-icon bi bi-percent"></i>Податок (%):</label>
                <input type="number" class="form-input" id="taxInput" min="0" max="100" step="1" value="23">
                
                <label class="form-label"><i class="info-icon bi bi-cash-coin"></i>Ціна для домогосподарств (грн/кВт·год):</label>
                <input type="number" class="form-input" id="domesticPriceInput" min="0.01" step="0.01" value="4.32">
            </div>

            <button type="submit" class="calc-button"><i class="bi bi-calculator"></i> Розрахувати</button>
        </form>
        
        <div id="resultBox" class="result-box" style="display:none;">
            <div id="resultContent"></div>
        </div>

        <div class="tips-section">
            <p><i class="bi bi-info-circle"></i> <strong>Про SolarGenWizard</strong></p>
            <p>SolarGenWizard допомагає розрахувати прогнозовану генерацію сонячної електростанції та оцінити фінансові переваги.</p>
            
            <p><i class="bi bi-sun"></i> <strong>Розрахунок генерації</strong></p>
            <p>Базується на:</p>
            <ul>
                <li>Потужності встановлених сонячних панелей</li>
                <li>Місячних показниках сонячної інсоляції для вибраного регіону</li>
                <li>Кількості днів у кожному місяці</li>
            </ul>
            
            <p><i class="bi bi-cash-coin"></i> <strong>Економічний аналіз</strong></p>
            <ul>
                <li>Аналіз власного споживання та економії коштів за тарифами для домогосподарств</li>
                <li>Розрахунок надлишку електроенергії, що може бути продана за "зеленим" тарифом</li>
                <li>Оцінка річного прибутку з урахуванням податків</li>
            </ul>
            
            <p><i class="bi bi-lightbulb"></i> <strong>Технічні примітки</strong></p>
            <ul>
                <li>ККД системи враховано як 80% від теоретично можливої генерації</li>
                <li>Зелений тариф: 0,16 €/кВт·год (з урахуванням ПДВ)</li>
                <li>Ціна для домогосподарств: 2,64 грн/кВт·год</li>
                <li>Розрахунок виконується помісячно з урахуванням сезонної зміни інсоляції</li>
            </ul>
        </div>
    </div>
    
    <script src="solarwizard.js"></script>
    <script>
    // Весь код виконуємо тільки після повного завантаження DOM
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM завантажено, ініціалізуємо калькулятор...");
        
        // --- КОНСТАНТИ ТА ДОВІДКОВІ ДАНІ ---
        const INSOLATION_DATA = {
            vinn: [1.3,1.9,2.9,3.8,4.5,5.1,5.5,5.1,3.9,2.6,1.4,1.1],
            dnip: [1.6,2.3,3.5,4.6,5.3,5.9,6.2,5.7,4.2,2.7,1.6,1.3],
            done: [1.5,2.2,3.3,4.3,5.0,5.7,6.0,5.5,4.0,2.6,1.5,1.2],
            zhyto: [1.1,1.7,2.7,3.7,4.4,5.0,5.3,4.9,3.7,2.4,1.2,0.9],
            zapor: [1.7,2.4,3.6,4.7,5.4,6.0,6.3,5.8,4.3,2.8,1.7,1.4],
            ifra: [1.0,1.6,2.6,3.6,4.3,4.9,5.2,4.8,3.6,2.3,1.1,0.8],
            kyiv: [1.1,1.7,2.7,3.7,4.4,5.0,5.3,4.9,3.7,2.4,1.2,0.9],
            krop: [1.4,2.0,3.1,4.1,4.8,5.4,5.7,5.2,3.9,2.5,1.4,1.1],
            lutsk: [1.0,1.5,2.5,3.5,4.2,4.8,5.1,4.7,3.5,2.2,1.1,0.8],
            luhan: [1.5,2.2,3.3,4.3,5.0,5.7,6.0,5.5,4.0,2.6,1.5,1.2],
            lviv: [1.0,1.5,2.5,3.5,4.2,4.8,5.1,4.7,3.5,2.2,1.1,0.8],
            myko: [1.7,2.4,3.6,4.7,5.4,6.0,6.3,5.8,4.3,2.8,1.7,1.4],
            odes: [1.7,2.4,3.6,4.7,5.4,6.0,6.3,5.8,4.3,2.8,1.7,1.4],
            polt: [1.3,1.9,2.9,3.8,4.5,5.1,5.5,5.1,3.9,2.6,1.4,1.1],
            rivn: [1.0,1.5,2.5,3.5,4.2,4.8,5.1,4.7,3.5,2.2,1.1,0.8],
            sumy: [1.1,1.7,2.7,3.7,4.4,5.0,5.3,4.9,3.7,2.4,1.2,0.9],
            symf: [1.8,2.5,3.7,4.8,5.5,6.1,6.4,5.9,4.4,2.9,1.8,1.5],
            tern: [1.0,1.6,2.6,3.6,4.3,4.9,5.2,4.8,3.6,2.3,1.1,0.8],
            uzho: [1.0,1.5,2.5,3.5,4.2,4.8,5.1,4.7,3.5,2.2,1.1,0.8],
            khark: [1.2,1.8,2.8,3.8,4.5,5.1,5.4,5.0,3.8,2.5,1.3,1.0],
            kher: [1.8,2.5,3.7,4.8,5.5,6.1,6.4,5.9,4.4,2.9,1.8,1.5],
            kmel: [1.1,1.7,2.7,3.7,4.4,5.0,5.3,4.9,3.7,2.4,1.2,0.9],
            cher: [1.1,1.7,2.7,3.7,4.4,5.0,5.3,4.9,3.7,2.4,1.2,0.9],
            chrn: [1.1,1.7,2.7,3.7,4.4,5.0,5.3,4.9,3.7,2.4,1.2,0.9],
            chrv: [1.2,1.8,2.8,3.8,4.5,5.1,5.4,5.0,3.8,2.5,1.3,1.0]
        };
        const REGION_NAMES = {
            vinn: "Вінниця", dnip: "Дніпро", done: "Донецьк", zhyto: "Житомир", zapor: "Запоріжжя",
            ifra: "Івано-Франківськ", kyiv: "Київ", krop: "Кропивницький", lutsk: "Луцьк", luhan: "Луганськ",
            lviv: "Львів", myko: "Миколаїв", odes: "Одеса", polt: "Полтава", rivn: "Рівне", sumy: "Суми",
            symf: "Сімферополь", tern: "Тернопіль", uzho: "Ужгород", khark: "Харків", kher: "Херсон",
            kmel: "Хмельницький", cher: "Черкаси", chrn: "Чернігів", chrv: "Чернівці"
        };
        const MONTHS_UA = ["Січень","Лютий","Березень","Квітень","Травень","Червень","Липень","Серпень","Вересень","Жовтень","Листопад","Грудень"];
        const DAYS_IN_MONTH = [31,28,31,30,31,30,31,31,30,31,30,31];
        const SYSTEM_EFFICIENCY = 0.8; // ККД системи
        const DOMESTIC_PRICE = 2.64; // грн/кВт·год
        const GREEN_TARIFF = 0.16; // €/кВт·год
        const PDV = 0.2; // 20% ПДВ
        
        // --- ОТРИМАННЯ ЕЛЕМЕНТІВ ФОРМИ ---
        const formElement = document.getElementById('solarWizardForm');
        const regionSelectElement = document.getElementById('regionSelect');
        const powerInputElement = document.getElementById('powerInput');
        const consumptionInputElement = document.getElementById('consumptionInput');
        const resultContentElement = document.getElementById('resultContent');
        const resultBoxElement = document.getElementById('resultBox');
        const autoPowerCheckboxElement = document.getElementById('autoPowerCheckbox');
        
        // Отримання елементів розширених параметрів
        const greenTariffInputElement = document.getElementById('greenTariffInput');
        const taxInputElement = document.getElementById('taxInput');
        const domesticPriceInputElement = document.getElementById('domesticPriceInput');
        const toggleAdvancedParamsElement = document.getElementById('toggleAdvancedParams');
        const advancedParamsElement = document.getElementById('advancedParams');
        
        // --- ПЕРЕВІРКА НАЯВНОСТІ ЕЛЕМЕНТІВ ---
        if (!formElement || !regionSelectElement || !powerInputElement || !consumptionInputElement || !resultContentElement || !resultBoxElement) {
            console.error("Помилка: не всі елементи знайдені");
            alert("Критична помилка: не всі елементи форми знайдені. Перезавантажте сторінку.");
            return;
        }
        
        // --- ЗАПОВНЕННЯ СПИСКУ РЕГІОНІВ ---
        regionSelectElement.innerHTML = Object.entries(REGION_NAMES)
            .map(([key, name]) => `<option value="${key}">${name}</option>`)
            .join('');
        console.log("Заповнено список регіонів");
        
        // --- ФУНКЦІЇ РОЗРАХУНКУ ---
        function calculateGeneration(region, powerKW) {
            const monthlyInsolation = INSOLATION_DATA[region];
            let monthlyGeneration = [];
            
            for (let i = 0; i < 12; i++) {
                const generationForMonth = monthlyInsolation[i] * powerKW * DAYS_IN_MONTH[i] * SYSTEM_EFFICIENCY;
                monthlyGeneration.push(generationForMonth);
            }
            
            return monthlyGeneration;
        }
        
        function calculateConsumption(monthlyGeneration, monthlyConsumption) {
            let ownMonthly = []; // Використано власної енергії
            let gridMonthly = []; // Взято з мережі
            let remainingMonthly = []; // Залишок для продажу
            let usedForOwnTotal = 0; // Загалом використано власної
            let gridTotal = 0; // Загалом взято з мережі
            
            for (let i = 0; i < 12; i++) {
                const ownNeed = monthlyConsumption;
                const solarGeneration = monthlyGeneration[i];
                const usedFromSolar = Math.min(solarGeneration, ownNeed);
                const takenFromGrid = Math.max(0, ownNeed - solarGeneration);
                const remaining = Math.max(0, solarGeneration - usedFromSolar);
                
                ownMonthly.push(usedFromSolar);
                gridMonthly.push(takenFromGrid);
                remainingMonthly.push(remaining);
                usedForOwnTotal += usedFromSolar;
                gridTotal += takenFromGrid;
            }
            
            return {
                ownMonthly,
                gridMonthly,
                remainingMonthly,
                usedForOwnTotal,
                gridTotal
            };
        }
        
        // --- ФУНКЦІЯ ВИВЕДЕННЯ РЕЗУЛЬТАТУ ---
        function displayResult(html) {
            resultContentElement.innerHTML = html;
            resultBoxElement.style.display = 'block';
            console.log("Результат виведено");
        }
        
        // --- РОБОТА З РОЗШИРЕНИМИ ПАРАМЕТРАМИ ---
        toggleAdvancedParamsElement.addEventListener('click', function(e) {
            e.preventDefault();
            advancedParamsElement.style.display = advancedParamsElement.style.display === 'none' ? 'block' : 'none';
        });
        
        // --- ФУНКЦІЯ АВТОПІДБОРУ ПОТУЖНОСТІ ---
        function calculateOptimalPower(region, monthlyConsumption) {
            // Найменша інсоляція в регіоні
            const minInsolation = Math.min(...INSOLATION_DATA[region]);
            const minInsolationMonth = INSOLATION_DATA[region].indexOf(minInsolation);
            
            // Кількість днів у місяці з найменшою інсоляцією
            const daysInMinMonth = DAYS_IN_MONTH[minInsolationMonth];
            
            // Знайти необхідну потужність сонячних панелей для покриття споживання
            // в місяць з найменшою інсоляцією, за формулою:
            // потужність = місячне_споживання / (інсоляція * дні_в_місяці * ККД)
            const optimalPower = monthlyConsumption / (minInsolation * daysInMinMonth * SYSTEM_EFFICIENCY);
            
            return {
                power: optimalPower,
                minInsolation: minInsolation,
                month: MONTHS_UA[minInsolationMonth]
            };
        }
        
        // --- ФУНКЦІЯ ОНОВЛЕННЯ ПОТУЖНОСТІ ПРИ АВТОПІДБОРІ ---
        function updatePowerWithAutoCalculation() {
            if (!autoPowerCheckboxElement.checked) {
                return;
            }
            
            const region = regionSelectElement.value;
            const consumption = parseFloat(consumptionInputElement.value.replace(',', '.')) || 0;
            
            if (!region || !(region in INSOLATION_DATA) || consumption <= 0) {
                return;
            }
            
            const optimalPowerData = calculateOptimalPower(region, consumption);
            const roundedPower = Math.ceil(optimalPowerData.power * 10) / 10; // Округлюємо до 0.1 кВт
            
            powerInputElement.value = roundedPower.toFixed(1);
            
            // Додаємо пояснення розрахунку в контейнер для підказки
            const powerInfoElement = document.getElementById('powerAutoInfo');
            if (powerInfoElement) {
                powerInfoElement.innerHTML = `<i class="bi bi-info-circle"></i> Розраховано на основі споживання ${consumption} кВт·год/міс 
                    у місяць з найменшою інсоляцією (${optimalPowerData.month}, ${optimalPowerData.minInsolation} кВт·год/м²/день)`;
                powerInfoElement.style.display = 'block';
            }
        }
        
        // --- ОБРОБНИК ДЛЯ АВТОПІДБОРУ ПОТУЖНОСТІ ---
        autoPowerCheckboxElement.addEventListener('change', function() {
            if (this.checked) {
                // Створюємо елемент для інформації про розрахунок, якщо він ще не існує
                if (!document.getElementById('powerAutoInfo')) {
                    const infoElement = document.createElement('div');
                    infoElement.id = 'powerAutoInfo';
                    infoElement.className = 'auto-power-info';
                    infoElement.style.display = 'none';
                    powerInputElement.parentNode.appendChild(infoElement);
                }
                
                // Вимикаємо поле введення потужності
                powerInputElement.disabled = true;
                
                // Автоматично розраховуємо потужність
                updatePowerWithAutoCalculation();
            } else {
                // Вмикаємо поле введення потужності
                powerInputElement.disabled = false;
                
                // Приховуємо інформацію про розрахунок
                const powerInfoElement = document.getElementById('powerAutoInfo');
                if (powerInfoElement) {
                    powerInfoElement.style.display = 'none';
                }
            }
        });
        
        // --- ОНОВЛЕННЯ ПОТУЖНОСТІ ПРИ ЗМІНІ ПАРАМЕТРІВ ---
        regionSelectElement.addEventListener('change', updatePowerWithAutoCalculation);
        consumptionInputElement.addEventListener('input', updatePowerWithAutoCalculation);
        
        // --- ОБРОБКА ФОРМИ ---
        formElement.addEventListener('submit', function(event) {
            event.preventDefault();
            console.log("Обробка форми...");
            
            try {
                // Отримання даних з форми
                const regionCode = regionSelectElement.value;
                const powerKW = parseFloat(powerInputElement.value.replace(',', '.'));
                const monthlyConsumption = parseFloat(consumptionInputElement.value.replace(',', '.')) || 0;
                
                // Отримання значень розширених параметрів (або використання значень за замовчуванням)
                const greenTariff = parseFloat(greenTariffInputElement.value.replace(',', '.')) || GREEN_TARIFF;
                const taxPercent = parseFloat(taxInputElement.value.replace(',', '.')) || PDV * 100;
                const taxRate = taxPercent / 100;
                const domesticPrice = parseFloat(domesticPriceInputElement.value.replace(',', '.')) || DOMESTIC_PRICE;
                
                console.log("Вхідні дані:", { 
                    regionCode, powerKW, monthlyConsumption,
                    greenTariff, taxRate, domesticPrice 
                });
                
                // Валідація введених даних
                if (!regionCode || !(regionCode in INSOLATION_DATA)) {
                    displayResult("❌ Оберіть коректний регіон.");
                    return;
                }
                if (isNaN(powerKW) || powerKW <= 0) {
                    displayResult("❌ Потужність панелей має бути більше 0.");
                    return;
                }
                if (monthlyConsumption < 0) {
                    displayResult("❌ Власне споживання має бути невід'ємним.");
                    return;
                }
                if (greenTariff <= 0) {
                    displayResult("❌ Зелений тариф має бути більше 0.");
                    return;
                }
                if (taxRate < 0 || taxRate > 1) {
                    displayResult("❌ Податок має бути в межах від 0% до 100%.");
                    return;
                }
                if (domesticPrice <= 0) {
                    displayResult("❌ Ціна для домогосподарств має бути більше 0.");
                    return;
                }
                
                // Розрахунок генерації
                const monthlyGeneration = calculateGeneration(regionCode, powerKW);
                const totalGeneration = monthlyGeneration.reduce((a, b) => a + b, 0);
                
                // Формування результату
                let resultHTML = `
<div class="result-header">
    <div class="result-title">🌍 ${REGION_NAMES[regionCode] || regionCode} - ${powerKW} кВт</div>
    <div class="result-subtitle">🔋 Річна генерація: ${Math.round(totalGeneration).toLocaleString('uk-UA')} кВт·год</div>
</div>`;

// Розрахунок для власного споживання
if (monthlyConsumption > 0) {
    const consumption = calculateConsumption(monthlyGeneration, monthlyConsumption);
    const annualConsumption = monthlyConsumption * 12;
    const coveragePercent = annualConsumption > 0 ? (consumption.usedForOwnTotal / annualConsumption) * 100 : 0;
    const savingsUAH = Math.round(consumption.usedForOwnTotal * domesticPrice);
    const remainingForSale = Math.max(0, totalGeneration - consumption.usedForOwnTotal);
    const remainingProfit = remainingForSale * greenTariff * (1 - taxRate);
    
    resultHTML += `
    <table class="result-table consumption-table">
        <caption>🏠 Аналіз споживання</caption>
        <tr>
            <td>☀️ Використано сонячної енергії:</td>
            <td><b>${Math.round(consumption.usedForOwnTotal).toLocaleString('uk-UA')}</b> кВт·год (${coveragePercent.toFixed(1)}%)</td>
        </tr>
        <tr>
            <td>⚡ Енергії з мережі:</td>
            <td><b>${Math.round(consumption.gridTotal).toLocaleString('uk-UA')}</b> кВт·год</td>
        </tr>
        <tr>
            <td>💰 Економія:</td>
            <td><b>${Math.round(consumption.usedForOwnTotal).toLocaleString('uk-UA')}</b> кВт·год (≈ ${savingsUAH.toLocaleString('uk-UA')} грн)</td>
        </tr>
        <tr>
            <td>🟢 Надлишок для продажу:</td>
            <td><b>${Math.round(remainingForSale).toLocaleString('uk-UA')}</b> кВт·год</td>
        </tr>
        <tr>
            <td>💵 Дохід (після податків):</td>
            <td><b>${remainingProfit.toLocaleString('uk-UA', {minimumFractionDigits:2, maximumFractionDigits:2})} €</b></td>
        </tr>
    </table>
    
    <table class="result-table monthly-table">
        <caption>📅 Місячні показники</caption>
        <tr class="table-header">
            <th>Місяць</th>
            <th>Генерація</th>
            <th>Власне</th>
            <th>З мережі</th>
            <th>На продаж</th>
        </tr>`;
        
    for (let i = 0; i < 12; ++i) {
        resultHTML += `
        <tr>
            <td>${MONTHS_UA[i].slice(0,3)}</td>
            <td>☀️ ${Math.round(monthlyGeneration[i])}</td>
            <td>🏠 ${Math.round(consumption.ownMonthly[i])}</td>
            <td>⚡ ${Math.round(consumption.gridMonthly[i])}</td>
            <td>🟢 ${Math.round(consumption.remainingMonthly[i])}</td>
        </tr>`;
    }
    
    resultHTML += `</table>`;
} else {
    const profitAfterTax = totalGeneration * greenTariff * (1 - taxRate);
    resultHTML += `
    <div class="result-profit">
        <div>💵 Дохід (після податків): <b>${profitAfterTax.toLocaleString('uk-UA', {minimumFractionDigits:2, maximumFractionDigits:2})} €</b></div>
    </div>
    
    <table class="result-table monthly-table">
        <caption>📅 Місячні показники</caption>
        <tr class="table-header">
            <th>Місяць</th>
            <th>Генерація</th>
        </tr>`;
        
    for (let i = 0; i < 12; ++i) {
        resultHTML += `
        <tr>
            <td>${MONTHS_UA[i].slice(0,3)}</td>
            <td>☀️ ${Math.round(monthlyGeneration[i])}</td>
        </tr>`;
    }
    
    resultHTML += `</table>`;
}

// Додаємо використані економічні параметри
resultHTML += `
<div class="result-params">
    <small><b>Використані фінансові параметри:</b> 
    Зелений тариф: ${greenTariff.toFixed(2)} €/кВт·год, 
    Податок: ${taxPercent}%, 
    Тариф для домогосподарств: ${domesticPrice.toFixed(2)} грн/кВт·год</small>
</div>`;

displayResult(resultHTML);
                
            } catch (error) {
                console.error("Помилка при обробці форми:", error);
                displayResult("❌ Помилка розрахунку: " + error.message);
            }
        });
        
        console.log("Калькулятор ініціалізовано");
    });
    </script>
</body>
</html>
